<?php
/**
 * @file
 * Install, update and uninstall functions for the Wizzlern Drupal front-end
 * training installation profile.
 */

/**
 * Implements hook_install().
 *
 * Perform actions to set up the site for this profile.
 *
 * @see system_install()
 */
function wizzlern_frontend_install() {

  // Enable some standard blocks.
  $default_theme = variable_get('theme_default', 'bartik');
  $admin_theme = 'seven';
  $blocks = array(
    array(
      'module' => 'system',
      'delta' => 'main',
      'theme' => $default_theme,
      'status' => 1,
      'weight' => 0,
      'region' => 'content',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'search',
      'delta' => 'form',
      'theme' => $default_theme,
      'status' => 1,
      'weight' => -1,
      'region' => 'sidebar_first',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'node',
      'delta' => 'recent',
      'theme' => $admin_theme,
      'status' => 1,
      'weight' => 10,
      'region' => 'dashboard_main',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'user',
      'delta' => 'login',
      'theme' => $default_theme,
      'status' => 1,
      'weight' => 0,
      'region' => 'sidebar_first',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'system',
      'delta' => 'navigation',
      'theme' => $default_theme,
      'status' => 1,
      'weight' => 0,
      'region' => 'sidebar_first',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'system',
      'delta' => 'powered-by',
      'theme' => $default_theme,
      'status' => 1,
      'weight' => 10,
      'region' => 'footer',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'system',
      'delta' => 'help',
      'theme' => $default_theme,
      'status' => 1,
      'weight' => 0,
      'region' => 'help',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'system',
      'delta' => 'main',
      'theme' => $admin_theme,
      'status' => 1,
      'weight' => 0,
      'region' => 'content',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'system',
      'delta' => 'help',
      'theme' => $admin_theme,
      'status' => 1,
      'weight' => 0,
      'region' => 'help',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'user',
      'delta' => 'login',
      'theme' => $admin_theme,
      'status' => 1,
      'weight' => 10,
      'region' => 'content',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'user',
      'delta' => 'new',
      'theme' => $admin_theme,
      'status' => 1,
      'weight' => 0,
      'region' => 'dashboard_sidebar',
      'pages' => '',
      'cache' => -1,
    ),
    array(
      'module' => 'search',
      'delta' => 'form',
      'theme' => $admin_theme,
      'status' => 1,
      'weight' => -10,
      'region' => 'dashboard_sidebar',
      'pages' => '',
      'cache' => -1,
    ),
  );
  $query = db_insert('block')->fields(array('module', 'delta', 'theme', 'status', 'weight', 'region', 'pages', 'cache'));
  foreach ($blocks as $block) {
    $query->values($block);
  }
  $query->execute();
}

/**
 * Implements hook_install_tasks().
 */
function wizzlern_frontend_install_tasks() {
  // Make sure we have at least 64M of memory.
  if (ini_get('memory_limit') != '-1' && ini_get('memory_limit') < '64M') {
    ini_set('memory_limit', '64M');
  }

  return array(
    'wizzlern_frontend_revert_features' => array(
      'display' => FALSE,
    ),
    'wizzlern_frontend_users' => array(
      'display' => FALSE,
    ),
    'wizzlern_frontend_users' => array(
      'display' => FALSE,
    ),
    'wizzlern_frontend_content' => array(
      'display' => FALSE,
    ),
  );
}

/*
 * Install task callback: Revert Features after the installation.
 */
function wizzlern_frontend_revert_features() {
  // Revert Features components to ensure that they are in their default states.
  $revert = array(
    'wizzlern_frontend_base' => array('variable'),
    'wizzlern_frontend_dtd4' => array('user_permission'),
  );

  features_revert($revert);
}

/*
 * Install task callback: Update users.
 */
function wizzlern_frontend_users() {

  // Assign user 1 the "administrator" role.
  $role = user_role_load_by_name('administrator');
  $user = user_load(1);
  $fields = array(
    'roles' => array($role->rid => $role->name),
  );
  user_save($user, $fields);
}

/*
 * Install task callback: Add content.
 */
function wizzlern_frontend_content() {
  module_enable(array('base2013_content'));
}
